                    <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @biodatum.name %> - Biodata Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&display=swap');
    
    .font-playfair {
      font-family: 'Playfair Display', serif;
    }
    
               .a4-preview {
             width: 210mm;
             height: 297mm;
             margin: 0 auto;
             background: white;
             box-shadow: 0 8px 32px rgba(0,0,0,0.15);
             position: relative;
             overflow: hidden;
           }

           .biodata-content {
             max-height: calc(297mm - 180px);
             overflow-y: auto;
           }

           .biodata-content::-webkit-scrollbar {
             width: 4px;
           }

           .biodata-content::-webkit-scrollbar-track {
             background: #f1f1f1;
           }

           .biodata-content::-webkit-scrollbar-thumb {
             background: #cbd5e0;
             border-radius: 2px;
           }

           .biodata-content::-webkit-scrollbar-thumb:hover {
             background: #a0aec0;
           }

           @media (max-width: 768px) {
             .a4-preview {
               width: 100%;
               height: auto;
               min-height: 297mm;
             }
             
             .biodata-content {
               max-height: none;
             }
           }
    
    .template-option {
      transition: all 0.3s ease;
    }
    
    .template-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .template-option.active {
      border-color: #ec4899;
      background-color: #fdf2f8;
      transform: scale(1.05);
    }
    
    @media print {
      .template-controls, .header-controls {
        display: none !important;
      }
      
      .a4-preview {
        box-shadow: none !important;
        margin: 0 !important;
        width: 100% !important;
        height: auto !important;
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header Controls -->
  <div class="header-controls bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <h1 class="text-2xl font-bold text-gray-900 font-playfair">
            <%= @biodatum.name %> - Preview
          </h1>
          <span class="text-sm text-gray-500">Template: <span id="current-template" class="font-semibold"><%= @biodatum.background_template.titleize %></span></span>
        </div>
        
        <div class="flex items-center space-x-3">
          <button onclick="window.print()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            <i class="fas fa-print mr-2"></i>
            Print
          </button>
          <button onclick="downloadAsImage()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            <i class="fas fa-download mr-2"></i>
            Download
          </button>
          <a href="<%= biodatum_path(@biodatum) %>" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Back
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Template Controls -->
  <div class="template-controls bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Choose Background Template</h2>
      
      <% template_images = {
        'watercolor-1' => 'watercolor-leaves-with-copy-space-design_53876-62980.jpg',
        'watercolor-2' => 'hand-drawn-watercolor-blue-flowers-leaves-post-card-isolated-white-can-be-used-cards-banners-invitations-label_635006-1614.jpg',
        'watercolor-3' => 'hand-drawn-watercolor-blue-flowers-leaves-post-card-isolated-white-can-be-used-cards-banners-invitations-label_635006-1705.jpg',
        'watercolor-4' => 'painted-watercolor-delicate-romantic-leaves-berries-pastel-floral-clip-art-perfect-wedding-postcard-making-diy-project-closeup-white-background_78967-4658.jpg',
        'watercolor-5' => 'painted-watercolor-delicate-romantic-leaves-berries-pastel-floral-clip-art-perfect-wedding-postcard-making-diy-project-closeup-white-background_78967-4656.jpg',
        'watercolor-6' => 'painted-watercolor-delicate-romantic-leaves-berries-pastel-floral-clip-art-perfect-wedding-postcard-making-diy-project-closeup-white-background_78967-4657.jpg',
        'elegant-1' => 'elegant-letterhead-design-company-hotels_1101622-4756.jpg',
        'elegant-2' => 'white-invitation-card-design-element_53876-1002931.jpg',
        'botanical-1' => 'leafy-paper-rectangle-frame-vector_53876-164690.jpg',
        'botanical-2' => 'leaf-png-border-transparent-background_53876-998568.jpg',
        'botanical-3' => 'watercolor-illustration-frame-with-eucalyptus-feathers-anemones-berries-hand-drawn-clipart_596988-29.jpg',
        'minimal' => 'minimalistic-invitation-template-with-white-background-autumn-leaves-watercolor-style_700253-1176.jpg',
        'copper' => 'rectangle-copper-frame-with-foliage-pattern-design-element_53876-1020729.jpg',
        'gold' => 'metallic-gold-border-frame-png-winter-effect_53876-972438.jpg',
        'marble' => 'black-marble-frame-png-with-green-leaf_53876-968983.jpg',
        'paper' => 'paper-list-with-flowers-bright-background_23-2147829589.jpg',
        'blue-copper' => 'hand-drawn-watercolor-blue-copper-leaves-post-card-isolated-white-can-be-used-cards-banners-invitations-label_635006-1663.jpg',
        'santa-plants' => 'santa-claus-plants-letter-template_23-2147964131.jpg'
      } %>
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-9 gap-3">
        <% Biodatum::BACKGROUND_TEMPLATES.each do |template| %>
          <button 
            class="template-option p-2 border-2 rounded-lg transition-all <%= 'active border-pink-500 bg-pink-50' if template == @biodatum.background_template %>"
            data-template="<%= template %>"
            onclick="changeTemplate('<%= template %>')"
            title="<%= template.titleize %>"
          >
            <div class="w-full h-16 bg-cover bg-center rounded mb-2" style="background-image: url('<%= asset_path(template_images[template]) %>');"></div>
            <div class="text-xs font-medium text-gray-700 truncate"><%= template.titleize %></div>
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Preview Container -->
  <div class="py-8">
    <div class="a4-preview" id="biodata-preview">
      <!-- Background Image -->
      <div class="background-image" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('<%= @biodatum.background_image_url %>'); background-size: cover; background-position: center; background-repeat: no-repeat; opacity: 0.15;"></div>
      
                   <!-- Content Overlay -->
             <div class="content-overlay" style="position: relative; z-index: 1; padding: 30px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column;">
               <!-- Header -->
               <div class="text-center mb-4">
                 <% if @biodatum.photo.attached? %>
                   <div class="mb-2">
                     <%= image_tag @biodatum.photo, alt: @biodatum.name, class: "w-20 h-20 rounded-full mx-auto object-cover border-4 border-white shadow-lg" %>
                   </div>
                 <% elsif @biodatum.photo.present? %>
                   <div class="mb-2">
                     <img src="<%= @biodatum.photo %>" alt="<%= @biodatum.name %>" class="w-20 h-20 rounded-full mx-auto object-cover border-4 border-white shadow-lg">
                   </div>
                 <% end %>
                 <h1 class="text-2xl font-bold text-gray-900 mb-1 font-playfair"><%= @biodatum.name %></h1>
                 <div class="w-12 h-1 bg-pink-500 mx-auto"></div>
               </div>

                       <!-- Dynamic Sections -->
               <div class="biodata-content flex-1 overflow-y-auto">
                 <% @biodatum.biodata_sections.each do |section| %>
                   <div class="section mb-3">
                     <h2 class="text-base font-bold text-pink-600 mb-1 border-b border-pink-200 pb-1 font-playfair">
                       <%= section.name %>
                     </h2>
                     
                     <div class="space-y-0">
                       <% section.biodata_fields.each do |field| %>
                         <div class="flex items-start py-1">
                           <div class="text-xs font-bold text-pink-600 uppercase tracking-wide min-w-[140px] mr-12 flex-shrink-0">
                             <%= field.label %>:
                           </div>
                           <div class="text-gray-800 text-xs flex-1 leading-tight">
                             <%= field.value.present? ? field.value : "Not specified" %>
                           </div>
                         </div>
                       <% end %>
                     </div>
                   </div>
                 <% end %>
               </div>

        <!-- Footer -->
        <div class="text-center pt-8 border-t-2 border-pink-200">
          <p class="text-gray-600 font-medium">
            Generated on <%= Date.current.strftime("%B %d, %Y") %>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const templateImages = {
      'watercolor-1': '<%= asset_path("watercolor-leaves-with-copy-space-design_53876-62980.jpg") %>',
      'watercolor-2': '<%= asset_path("hand-drawn-watercolor-blue-flowers-leaves-post-card-isolated-white-can-be-used-cards-banners-invitations-label_635006-1614.jpg") %>',
      'watercolor-3': '<%= asset_path("hand-drawn-watercolor-blue-flowers-leaves-post-card-isolated-white-can-be-used-cards-banners-invitations-label_635006-1705.jpg") %>',
      'watercolor-4': '<%= asset_path("painted-watercolor-delicate-romantic-leaves-berries-pastel-floral-clip-art-perfect-wedding-postcard-making-diy-project-closeup-white-background_78967-4658.jpg") %>',
      'watercolor-5': '<%= asset_path("painted-watercolor-delicate-romantic-leaves-berries-pastel-floral-clip-art-perfect-wedding-postcard-making-diy-project-closeup-white-background_78967-4656.jpg") %>',
      'watercolor-6': '<%= asset_path("painted-watercolor-delicate-romantic-leaves-berries-pastel-floral-clip-art-perfect-wedding-postcard-making-diy-project-closeup-white-background_78967-4657.jpg") %>',
      'elegant-1': '<%= asset_path("elegant-letterhead-design-company-hotels_1101622-4756.jpg") %>',
      'elegant-2': '<%= asset_path("white-invitation-card-design-element_53876-1002931.jpg") %>',
      'botanical-1': '<%= asset_path("leafy-paper-rectangle-frame-vector_53876-164690.jpg") %>',
      'botanical-2': '<%= asset_path("leaf-png-border-transparent-background_53876-998568.jpg") %>',
      'botanical-3': '<%= asset_path("watercolor-illustration-frame-with-eucalyptus-feathers-anemones-berries-hand-drawn-clipart_596988-29.jpg") %>',
      'minimal': '<%= asset_path("minimalistic-invitation-template-with-white-background-autumn-leaves-watercolor-style_700253-1176.jpg") %>',
      'copper': '<%= asset_path("rectangle-copper-frame-with-foliage-pattern-design-element_53876-1020729.jpg") %>',
      'gold': '<%= asset_path("metallic-gold-border-frame-png-winter-effect_53876-972438.jpg") %>',
      'marble': '<%= asset_path("black-marble-frame-png-with-green-leaf_53876-968983.jpg") %>',
      'paper': '<%= asset_path("paper-list-with-flowers-bright-background_23-2147829589.jpg") %>',
      'blue-copper': '<%= asset_path("hand-drawn-watercolor-blue-copper-leaves-post-card-isolated-white-can-be-used-cards-banners-invitations-label_635006-1663.jpg") %>',
      'santa-plants': '<%= asset_path("santa-claus-plants-letter-template_23-2147964131.jpg") %>'
    };

    function changeTemplate(template) {
      // Update the background image
      const backgroundImage = document.querySelector('.background-image');
      backgroundImage.style.backgroundImage = `url('${templateImages[template]}')`;
      
      // Update active template button
      document.querySelectorAll('.template-option').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update the current template display
      document.getElementById('current-template').textContent = template.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      // Update the biodatum in the database
      fetch('<%= biodatum_path(@biodatum) %>', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': '<%= form_authenticity_token %>'
        },
        body: JSON.stringify({
          biodatum: {
            background_template: template
          }
        })
      }).then(response => {
        if (response.ok) {
          console.log('Template updated successfully');
        } else {
          console.error('Failed to update template');
        }
      });
    }

    function downloadAsImage() {
      // Use html2canvas to capture the biodata as an image
      const element = document.getElementById('biodata-preview');
      
      // Load html2canvas if not already loaded
      if (typeof html2canvas === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = function() {
          captureAndDownload();
        };
        document.head.appendChild(script);
      } else {
        captureAndDownload();
      }
      
      function captureAndDownload() {
        html2canvas(element, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: null
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = '<%= @biodatum.name.parameterize %>-biodata.png';
          link.href = canvas.toDataURL();
          link.click();
        });
      }
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'p':
            e.preventDefault();
            window.print();
            break;
          case 's':
            e.preventDefault();
            downloadAsImage();
            break;
        }
      }
    });
  </script>
</body>
</html> 