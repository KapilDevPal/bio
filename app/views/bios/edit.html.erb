<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 font-playfair">
        <i class="fas fa-edit text-pink-500 mr-3"></i>
        Edit Your Biodata
      </h1>
      <p class="text-gray-600 mt-2">Customize your marriage biodata and see live preview</p>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3 mt-4 lg:mt-0">
      <a href="<%= download_pdf_bio_path(@bio, format: :pdf) %>" target="_blank" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="fas fa-download mr-2"></i>
        Download PDF
      </a>
      <button onclick="showQRCode()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="fas fa-qrcode mr-2"></i>
        QR Code
      </button>
      <button onclick="copyShareLink()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="fas fa-share mr-2"></i>
        Share Link
      </button>
      <button onclick="resetForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="fas fa-undo mr-2"></i>
        Reset
      </button>
    </div>
  </div>

  <!-- Language Selector -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <i class="fas fa-language text-gray-500 mr-3"></i>
        <label class="text-sm font-medium text-gray-700">Language:</label>
      </div>
      <select id="language-selector" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
        <option value="en" <%= 'selected' if @bio.language_code == 'en' %>>English</option>
        <option value="hi" <%= 'selected' if @bio.language_code == 'hi' %>>हिंदी (Hindi)</option>
        <option value="pa" <%= 'selected' if @bio.language_code == 'pa' %>>ਪੰਜਾਬੀ (Punjabi)</option>
        <option value="mr" <%= 'selected' if @bio.language_code == 'mr' %>>मराठी (Marathi)</option>
        <option value="te" <%= 'selected' if @bio.language_code == 'te' %>>తెలుగు (Telugu)</option>
        <option value="ta" <%= 'selected' if @bio.language_code == 'ta' %>>தமிழ் (Tamil)</option>
      </select>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Form Section -->
    <div class="space-y-6">
      <%= form_with model: @bio, local: true do |form| %>
        <%= form.hidden_field :language_code, id: "bio_language_code" %>
        
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
              <i class="fas fa-edit text-blue-500 mr-2"></i>
              Biodata Form
            </h2>
          </div>
          
          <div class="p-6">
            <div id="sections-container" class="space-y-6">
              <% @bio.sections.each do |section| %>
                <div class="section-container border border-gray-200 rounded-lg p-4" data-section-id="<%= section.id %>" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                  <div class="flex items-center justify-between mb-4" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h3 class="text-lg font-medium text-gray-900" style="font-size: 18px; font-weight: 500; color: #111827;">
                      <%= section.name %>
                    </h3>
                    <div class="flex items-center space-x-2" style="display: flex; align-items: center; gap: 8px;">
                      <button type="button" onclick="addField(this)" class="text-green-600 hover:text-green-800" style="color: #059669; cursor: pointer;">
                        <i class="fas fa-plus"></i>
                      </button>
                      <button type="button" onclick="removeSection(this)" class="text-red-600 hover:text-red-800" style="color: #dc2626; cursor: pointer;">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="fields-container space-y-3" style="display: flex; flex-direction: column; gap: 12px;">
                    <% section.fields.each do |field| %>
                      <div class="field-container flex items-center space-x-3" data-field-id="<%= field.id %>" style="display: flex; align-items: center; gap: 12px; padding: 8px; border: 1px solid #f3f4f6; border-radius: 6px; background-color: #f9fafb;">
                        <div class="flex-1" style="flex: 1;">
                          <input type="text" name="bio[sections_attributes][<%= section.id %>][fields_attributes][<%= field.id %>][label]" 
                                 value="<%= field.label %>"
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
                                 placeholder="Field Label"
                                 style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background-color: white;">
                        </div>
                        <div class="flex-1" style="flex: 1;">
                          <textarea name="bio[sections_attributes][<%= section.id %>][fields_attributes][<%= field.id %>][value]" 
                                    rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
                                    placeholder="Field Value"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background-color: white; resize: vertical;"><%= field.value %></textarea>
                        </div>
                        <button type="button" onclick="removeField(this)" class="text-red-600 hover:text-red-800" style="color: #dc2626; cursor: pointer; padding: 4px;">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
            
            <div class="mt-6" style="margin-top: 24px;">
              <button type="button" onclick="addSection()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded-lg transition-colors" style="width: 100%; background-color: #f3f4f6; color: #374151; padding: 12px 16px; border-radius: 8px; border: none; cursor: pointer;">
                <i class="fas fa-plus mr-2"></i>
                Add New Section
              </button>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end space-x-4 mt-6" style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 24px;">
          <%= form.submit "Save Changes", 
              class: "bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors",
              style: "background-color: #ec4899; color: white; font-weight: 600; padding: 8px 24px; border-radius: 8px; border: none; cursor: pointer;" %>
        </div>
      <% end %>
    </div>

    <!-- Preview Section -->
    <div class="space-y-6">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200" style="background-color: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
        <div class="px-6 py-4 border-b border-gray-200" style="padding: 16px 24px; border-bottom: 1px solid #e5e7eb;">
          <h2 class="text-lg font-semibold text-gray-900" style="font-size: 18px; font-weight: 600; color: #111827;">
            <i class="fas fa-eye text-green-500 mr-2"></i>
            Live Preview
          </h2>
        </div>
        
        <div class="p-6" style="padding: 24px;">
          <div id="preview" class="min-h-[600px]" style="min-height: 600px;">
            <%= render 'preview', bio: @bio %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QR Code Modal -->
<div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: none; z-index: 50;">
  <div class="flex items-center justify-center min-h-screen p-4" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 16px;">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full" style="background-color: white; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%;">
      <div class="text-center">
        <h3 class="text-lg font-semibold text-gray-900 mb-4" style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 16px;">QR Code for Editing</h3>
        <div id="qr-code-container" class="mb-4" style="margin-bottom: 16px;"></div>
        <p class="text-sm text-gray-600 mb-4" style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">Scan this QR code to edit your biodata later</p>
        <button onclick="closeQRModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors" style="background-color: #6b7280; color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Language selector
  document.getElementById('language-selector').addEventListener('change', function() {
    document.getElementById('bio_language_code').value = this.value;
    updatePreview();
  });

  // Add section
  function addSection() {
    const container = document.getElementById('sections-container');
    const sectionIndex = container.children.length;
    
    const sectionHtml = `
      <div class="section-container border border-gray-200 rounded-lg p-4" data-section-id="new-${sectionIndex}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <div class="flex items-center justify-between mb-4" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
          <h3 class="text-lg font-medium text-gray-900" style="font-size: 18px; font-weight: 500; color: #111827;">
            <input type="text" name="bio[sections_attributes][${sectionIndex}][name]" 
                   class="font-medium text-gray-900 bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-pink-500 rounded px-2 py-1"
                   placeholder="Section Name" value="New Section" style="font-weight: 500; color: #111827; background: transparent; border: none; padding: 4px 8px; border-radius: 4px;">
          </h3>
          <div class="flex items-center space-x-2" style="display: flex; align-items: center; gap: 8px;">
            <button type="button" onclick="addField(this)" class="text-green-600 hover:text-green-800" style="color: #059669; cursor: pointer;">
              <i class="fas fa-plus"></i>
            </button>
            <button type="button" onclick="removeSection(this)" class="text-red-600 hover:text-red-800" style="color: #dc2626; cursor: pointer;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="fields-container space-y-3" style="display: flex; flex-direction: column; gap: 12px;">
        </div>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', sectionHtml);
  }

  // Add field
  function addField(button) {
    const section = button.closest('.section-container');
    const fieldsContainer = section.querySelector('.fields-container');
    const fieldIndex = fieldsContainer.children.length;
    const sectionIndex = Array.from(document.querySelectorAll('.section-container')).indexOf(section);
    
    const fieldHtml = `
      <div class="field-container flex items-center space-x-3" data-field-id="new-${fieldIndex}" style="display: flex; align-items: center; gap: 12px; padding: 8px; border: 1px solid #f3f4f6; border-radius: 6px; background-color: #f9fafb;">
        <div class="flex-1" style="flex: 1;">
          <input type="text" name="bio[sections_attributes][${sectionIndex}][fields_attributes][${fieldIndex}][label]" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
                 placeholder="Field Label" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background-color: white;">
        </div>
        <div class="flex-1" style="flex: 1;">
          <textarea name="bio[sections_attributes][${sectionIndex}][fields_attributes][${fieldIndex}][value]" 
                    rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
                    placeholder="Field Value" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background-color: white; resize: vertical;"></textarea>
        </div>
        <button type="button" onclick="removeField(this)" class="text-red-600 hover:text-red-800" style="color: #dc2626; cursor: pointer; padding: 4px;">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
    
    fieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
  }

  // Remove section
  function removeSection(button) {
    const section = button.closest('.section-container');
    section.remove();
  }

  // Remove field
  function removeField(button) {
    const field = button.closest('.field-container');
    field.remove();
  }

  // Show QR Code
  function showQRCode() {
    const modal = document.getElementById('qr-modal');
    const container = document.getElementById('qr-code-container');
    
    // Generate QR code using a library or API
    const editUrl = '<%= @bio.edit_url %>';
    container.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(editUrl)}" alt="QR Code">`;
    
    modal.style.display = 'flex';
  }

  // Close QR Modal
  function closeQRModal() {
    document.getElementById('qr-modal').style.display = 'none';
  }

  // Copy share link
  function copyShareLink() {
    const publicUrl = '<%= @bio.public_url %>';
    navigator.clipboard.writeText(publicUrl).then(() => {
      alert('Public link copied to clipboard!');
    });
  }

  // Reset form
  function resetForm() {
    if (confirm('Are you sure you want to reset the form? This will clear all your changes.')) {
      location.reload();
    }
  }

  // Update preview
  function updatePreview() {
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    fetch('<%= edit_bio_path(@bio.edit_token) %>', {
      method: 'PATCH',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.text())
    .then(html => {
      document.getElementById('preview').innerHTML = html;
    });
  }

  // Auto-save on input change
  document.addEventListener('input', function(e) {
    if (e.target.matches('input, textarea, select')) {
      setTimeout(updatePreview, 1000);
    }
  });
</script>
